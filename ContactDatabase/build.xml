<?xml version="1.0" encoding="UTF-8" ?>
<!-- 
	Ant build file for the documentation tutorial code
	Writer of a chapter with an example have to include a foroward
	to their build file.  This latest build file suppose arguments 
	sets here :
		src.dir : Directory where the source are : manual\src\examples
		build.dir : Base directory where to store generated files (class/ejb/war/...)
		classpath : Classpath used to make any compilation (set up here by verifing 
			which version of JBoss is used.
	
  -->

<project name="CMP" default="contact-compile" basedir="./">

    <property environment="env" />
    <!-- Override with your JBoss server dist location if the JBOSS_DIST env var is not set -->
    <property name="jboss.dist" value="${env.JBOSS_DIST}"/>

    <property name="src.dir" value="${basedir}"/>
    <property name="src.resources" value="${basedir}/resources"/>
    <property name="build.dir" value="${basedir}/build"/>
    <property name="dist.dir" value="${basedir}/dist"/>
    <property name="build.classes.dir" value="${build.dir}/cmp-contact/classes"/>
    <property name="build.ejb.dir" value="${build.dir}/cmp-contact/ejb"/>

    <target name="validate-servlet">
        <!-- Override with your web server servlet jar location. 
             The default assumes that JBOSS_DIST points to a 
             JBoss/Tomcat bundle distribution
         -->
        <available property="servlet.jar" value="${env.JBOSS_DIST}/../tomcat/lib/servlet.jar" file="${env.JBOSS_DIST}/../tomcat/lib/servlet.jar"/>
        <available property="servlet.jar" value="${env.JBOSS_DIST}/../jetty/lib/javax.servlet.jar" file="${env.JBOSS_DIST}/../jetty/lib/javax.servlet.jar"/>
        <available property="servlet.jar" value="${env.JBOSS_DIST}/../catalina/common/lib/servlet.jar" file="${env.JBOSS_DIST}/../catalina/common/lib/servlet.jar"/>
        <available property="servlet.jar" value="${env.JBOSS_DIST}/../catalina/common/lib/servlet.jar" file="${env.TOMCAT_HOME}/lib/servlet.jar"/>
        <property name="servlet.jar" value="COULD_NOT_FIND_SERVLET_JAR"/>

        <path id="base.path_22">
            <pathelement location="${jboss.dist}/client/ejb.jar"/>
            <pathelement location="${jboss.dist}/client/jaas.jar"/>
            <pathelement location="${jboss.dist}/client/jbosssx-client.jar"/>
            <pathelement location="${jboss.dist}/client/jboss-client.jar"/>
            <pathelement location="${jboss.dist}/client/jnp-client.jar"/>
            <pathelement location="${servlet.jar}"/>
        </path>
        <path id="base.path_24">
            <pathelement location="${jboss.dist}/client/jboss-j2ee.jar"/>
            <pathelement location="${jboss.dist}/client/jaas.jar"/>
            <pathelement location="${jboss.dist}/client/jbosssx-client.jar"/>
            <pathelement location="${jboss.dist}/client/jboss-client.jar"/>
            <pathelement location="${jboss.dist}/client/jnp-client.jar"/>
            <pathelement location="${servlet.jar}"/>
        </path>
    </target>

    <target name="validate-jboss" depends="validate-servlet">
        <available property="classpath_id" value="base.path_22" file="${jboss.dist}/client/ejb.jar" />
        <available property="classpath_id" value="base.path_24" file="${jboss.dist}/client/jboss-j2ee.jar" />

    </target>
    
    <target name="fail_if_not_valid" unless="classpath_id">
        <fail message="jboss.dist=${jboss.dist} is not a valid JBOSS_DIST directory. If using a bundled JBoss version set JBOSS_DIST to the jboss/ subdir."/>
    </target>
    
    <target name="init" depends="validate-jboss,fail_if_not_valid">
        <property name="classpath" refid="${classpath_id}" />
        <echo message="Using JBoss directory=${jboss.dist}" />
        <echo message="Using base classpath=${classpath}" />
        <echo message="Using Source directory=${src.dir}" />
        <echo message="Using Build directory=${build.dir}" />
    </target>
    
    <!-- Clean build and dist -->
    <target name="clean" depends="init">
    	<delete dir="${build.dir}"/>
    	<delete dir="${dist.dir}"/>
    </target>

	<!-- No default Target -->
    <target name="main" depends="init">
		<echo message="Specify which target you want to run. Example: build cmp-contact-list" />
    </target>
    
	<!-- Target to create files to store on the Web site -->
	
    <target name="dist" depends="clean">
    	<mkdir dir="${dist.dir}"/>
    	<!-- Bundle all the sources and build script in one file -->
    	<zip zipfile="${dist.dir}/documentation-example.zip" basedir="${src.dir}/../"
          includes="examples/**" />
      <tar tarfile="${dist.dir}/documentation-example.tar" basedir="${src.dir}/../"
          includes="examples/**" />
      <gzip src="${dist.dir}/documentation-example.tar" zipfile="${dist.dir}/documentation-example.tar.gz" />
		<!-- Add Chapter specific files here 
		<antcall target="cmp-cd-dist" />
		-->
    </target>

    <target name="contact-compile" depends="init">
        <mkdir dir="${build.dir}"/>
    	<mkdir dir="${build.classes.dir}"/>
    	<mkdir dir="${build.ejb.dir}"/>
    	<javac srcdir="${src.dir}"
           destdir="${build.classes.dir}"
           classpath="${classpath}"
           debug="on"
           deprecation="on"
           optimize="off"
       	   includes="com/headius/contact/**"
    	/>
    	<mkdir dir="${build.classes.dir}/META-INF"/>
    	<copy file="${src.dir}/resources/ejb-jar.xml" tofile="${build.classes.dir}/META-INF/ejb-jar.xml" />
    	<copy file="${src.dir}/resources/jboss.xml" tofile="${build.classes.dir}/META-INF/jboss.xml" />
    	<jar jarfile="${build.ejb.dir}/contact.jar"
        	basedir="${build.classes.dir}"
         	includes="META-INF/**,com/headius/contact/**"
         	/>
        
        <!-- JNDI Client used to connect to JBoss running on localhost -->
        <copy file="${basedir}/resources/jndi.properties" tofile="${build.classes.dir}/jndi.properties" />
    </target>
    
    <target name="contact-dist" depends="contact-compile">
    	<!-- Nothing special here -->
    </target>
    
    <target name="contact-list" depends="init">
        <ant antfile="${src.dir}/build/build-client.xml" target="main">
            <property name="client" value="List"/>
        </ant>
    </target>
    
    <target name="contact-upload" depends="init">
        <ant antfile="${src.dir}/build/build-client.xml" target="main">
            <property name="client" value="Upload"/>
        </ant>
    </target>

    <target name="contact-remove" depends="init">
        <ant antfile="${src.dir}/build/build-client.xml" target="main">
            <property name="client" value="Remove"/>
        </ant>
    </target>

    <target name="contact-client-build" depends="init">
        <mkdir dir="${build.dir}"/>
        <javac srcdir="${src.dir}"
            destdir="${build.dir}"
            classpath="${classpath}"
            debug="on"
            deprecation="on"
            optimize="off"
            includes="com/headius/contact/ContactClient.java" />
    </target>
    
</project>
